<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DreamEcho - Profesor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      text-align: center;
      background-color: #c1f7f2;
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
    }
    .marco {
      width: 90%;
      max-width: 700px;
      margin: 1em auto;
      padding: 1em;
      background: white;
      border: 5px solid blue;
      border-radius: 1em;
      box-sizing: border-box;
    }
    h1 { font-size: 2.5em; margin: 0.2em 0; }
    .pin-section { margin-bottom: 1em; }
    .pin-section input {
      padding: .6em; font-size: 1em; width: 60%; margin-right: .5em;
    }
    .pin-section button {
      padding: .6em 1em; font-size: 1em;
      cursor: pointer; border: none; border-radius: .7em;
      background: #2196f3; color: #fff;
    }
    #mainContent { display: none; }
    #recuentoOyentes, #status {
      font-size: 1.1em; color: #555; margin: .5em 0;
    }
    .video-container {
      display: flex; gap: 1em; justify-content: center;
      flex-wrap: nowrap; margin: 1em 0;
    }
    .video-block {
      flex: 1 1 45%; display: flex;
      flex-direction: column; align-items: center;
    }
    .video-block video {
      width: 100%; max-height: 250px;
      background: black; border-radius: .5em;
    }
    .video-label {
      margin-top: .3em; font-weight: bold; color: #333;
    }
    #talkBtn {
      padding: .8em 2em; font-size: 1.1em; margin: 1em 0; margin-top: -30px;
      border: none; border-radius: .7em;
      background: #2196f3; color: white;
      cursor: pointer; user-select: none;
    }
    #talkBtn:active {
      transform: scale(.96); background: red;
    }
    .midi-section {
      margin: 1.5em 0; text-align: center;
    }
    .midi-section h3 {
      margin-bottom: .5em; font-size: 1.2em;
    }
    .midi-controls {
      display: flex; justify-content: center;
      align-items: center; gap: 1em; margin-bottom: .5em;
    }
    .midi-controls .label { font-weight: bold; }
    .midi-controls select {
      padding: .4em; font-size: 1em;
    }
    #virtualBtn {
      padding: .6em 1em; font-size: 1em; cursor: pointer;
    }
    #midiStatus, #midiSendStatus {
      margin-top: .5em; color: #555;
    }
    /* contenedor del teclado SVG */
    #keyboard {
      width: 100%; max-width: 700px;
      height: 150px; margin: 1.5em auto; margin-bottom: -10px;
      transition: opacity .3s;
    }
    /* Simon button */
    #simonBtn {
      padding: .6em 1em; font-size: 1.1em;
      border: none; border-radius: .7em;
      background: #4caf50; color: white;
      cursor: pointer;
      user-select: none;
      transition: background .2s;
    }
    #simonBtn.active {
      background: #388e3c;
    }
    #simonStatus {
      font-size: 1.5em;
      font-weight: bold;
      margin: 0.5em 0;
    }
  </style>
</head>
<body>
  <div class="marco">
    <h1>DreamEcho - Profesor</h1>
    <p><a href="https://www.youtube.com/@rafgim" target="_blank" rel="noopener">
      Â© By Rafael Gimeno
    </a></p>

    <div id="pinSection" class="pin-section">
      <input type="text" id="pinInput" placeholder="Introduce tu PIN de la sala">
      <button id="pinBtn">Crear sala</button>
    </div>

    <div id="mainContent">
      <div class="video-container">
        <div class="video-block">
          <video id="localVideo" autoplay muted playsinline></video>
          <p class="video-label">TÃº</p>
        </div>
        <div class="video-block">
          <video id="remoteVideo" autoplay playsinline></video>
          <p class="video-label">Alumno</p>
        </div>
      </div>

      <div id="keyboard"></div>

      <div style="margin: 1em 0;">
        <button id="simonBtn">ðŸŽ® Jugar Simon</button>
      </div>
      <div id="simonStatus"></div>

      <button id="talkBtn">ðŸ“¢ MantÃ©n pulsado para hablar</button>

      <div class="midi-section">
        <h3>MIDI recibido (del alumno):</h3>
        <div class="midi-controls">
          <span class="label">Seleccionar piano digital</span>
          <div id="midiOutSelectCont"></div>
          <button id="virtualBtn">ðŸŽ§ Usar sonido virtual</button>
        </div>
        <div id="midiStatus"></div>
      </div>

      <div class="midi-section">
        <h3>MIDI a enviar (tu piano):</h3>
        <div id="midiInSelectCont"></div>
        <div id="midiSendStatus"></div>
      </div>

      <p id="recuentoOyentes">Oyentes conectados: --</p>
      <p id="status">Esperando conexiÃ³nâ€¦</p>
    </div>
  </div>

  <!-- PianoKeys desde Skypack -->
  <script type="module">
    import PianoKeys from 'https://cdn.skypack.dev/@jesperdj/pianokeys@1.0.6';
    window.PianoKeys = PianoKeys;
  </script>

  <script>
    let pin = null;
    const pinSection        = document.getElementById('pinSection');
    const pinInput          = document.getElementById('pinInput');
    const pinBtn            = document.getElementById('pinBtn');
    const mainContent       = document.getElementById('mainContent');
    const statusEl          = document.getElementById('status');
    const oyentesEl         = document.getElementById('recuentoOyentes');
    const localVideo        = document.getElementById('localVideo');
    const remoteVideo       = document.getElementById('remoteVideo');
    const talkBtn           = document.getElementById('talkBtn');
    const virtualBtn        = document.getElementById('virtualBtn');
    const midiOutSelectCont = document.getElementById('midiOutSelectCont');
    const midiStatus        = document.getElementById('midiStatus');
    const midiInSelectCont  = document.getElementById('midiInSelectCont');
    const midiSendStatus    = document.getElementById('midiSendStatus');
    const keyboardEl        = document.getElementById('keyboard');
    const simonBtn          = document.getElementById('simonBtn');
    const simonStatus       = document.getElementById('simonStatus');

    let ws, pc, piano;
    let realAudioTrack, silentAudioTrack, audioSender;
    let pressingTalk = false, remoteSpeaking = false;
    let midiAccess, midiInputs = [], midiOutputs = [], midiOutDevice, midiInDevice, midiChannel;
    let synth, useVirtual = true;

    // Handler MIDI local
    let localMidiHandler = null;
    // Control Simon
    const myRole = 'profesor';
    let simonSeq = [], turn = null, step = 0;
    let canSendMidi = false;

    // â€” Silent audio for PTT â€”
    function createSilentAudioTrack() {
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      osc.frequency.value = 0;
      const dst = ctx.createMediaStreamDestination();
      osc.connect(dst);
      osc.start();
      setTimeout(()=>osc.stop(),100);
      return dst.stream.getAudioTracks()[0];
    }

    // â€” Init video & audio â€”
    async function initLocalVideo() {
      const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      realAudioTrack   = stream.getAudioTracks()[0];
      silentAudioTrack = createSilentAudioTrack();
      localVideo.srcObject = stream;
      stream.getTracks().forEach(track => {
        const sender = pc.addTrack(track, stream);
        if (track.kind === 'audio') audioSender = sender;
      });
      if (audioSender) audioSender.replaceTrack(silentAudioTrack);
    }
    function updateMicState() {
      if (!audioSender) return;
      const track = (pressingTalk && !remoteSpeaking) ? realAudioTrack : silentAudioTrack;
      if (audioSender.track !== track) audioSender.replaceTrack(track);
    }
    function pressTalk() {
      pressingTalk = true;
      sendMessage({ type:'talk', speaking:true });
      talkBtn.style.background = 'red';
      updateMicState();
    }
    function releaseTalk() {
      pressingTalk = false;
      sendMessage({ type:'talk', speaking:false });
      talkBtn.style.background = '';
      updateMicState();
    }
    ['mousedown','touchstart'].forEach(e=>talkBtn.addEventListener(e,pressTalk));
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(e=>talkBtn.addEventListener(e,releaseTalk));

    // â€” WebSocket & WebRTC â€”
    function sendMessage(obj) {
      obj.pin = pin;
      ws.send(JSON.stringify(obj));
    }
    async function startWebRTC() {
      pc = new RTCPeerConnection({ iceServers:[{ urls:'stun:stun.l.google.com:19302' }] });
      midiChannel = pc.createDataChannel('midi',{ ordered:true });
      midiChannel.onmessage = ({ data }) => handleDataChannel(JSON.parse(data));
      await initLocalVideo();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      sendMessage({ type:'signal', offer:pc.localDescription });
      pc.onicecandidate = ({ candidate }) => { if(candidate) sendMessage({ type:'signal', candidate }); };
      pc.ontrack = ev => { remoteVideo.srcObject = ev.streams[0]; };
      pc.ondatachannel = ev => {
        if(ev.channel.label==='midi') {
          midiChannel = ev.channel;
          midiChannel.onmessage = ({ data }) => handleDataChannel(JSON.parse(data));
        }
      };
    }

    pinBtn.onclick = () => {
      const v = pinInput.value.trim(); if(!v) return;
      pin = v; pinSection.style.display='none'; mainContent.style.display='block';
      piano = new PianoKeys.Keyboard(keyboardEl,{
        width:keyboardEl.clientWidth,
        height:keyboardEl.clientHeight,
        keyColour:'#fff',
        accidentalKeyColour:'#000',
        activeColour:'#4a4'
      });
      ws = new WebSocket('wss://dreamecho.onrender.com');
      ws.onopen = () => {
        statusEl.textContent='Conectadoâ€¦';
        sendMessage({ type:'ping' });
        startWebRTC();
        setupMIDI();
        setupSampler();
      };
      ws.onmessage = async ({ data }) => {
        const msg = JSON.parse(typeof data==='string'?data:await data.text());
        switch(msg.type){
          case 'stats': oyentesEl.textContent = `Oyentes conectados: ${msg.clients}`; break;
          case 'talk': remoteSpeaking = msg.speaking; updateMicState(); break;
          case 'signal':
            if(msg.pin!==pin) return;
            if(msg.offer){
              await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
              const ans = await pc.createAnswer();
              await pc.setLocalDescription(ans);
              sendMessage({ type:'signal', answer:pc.localDescription });
            } else if(msg.answer){
              await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
            } else if(msg.candidate){
              await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
            }
            break;
        }
      };
      ws.onerror = ()=>{ statusEl.textContent='Error de conexiÃ³n.'; };
      ws.onclose = ()=>{ statusEl.textContent='ConexiÃ³n cerrada.'; };
    };

    // â€” MIDI setup & sampler â€”
    async function setupMIDI() {
      midiAccess  = await navigator.requestMIDIAccess();
      midiInputs  = Array.from(midiAccess.inputs.values());
      midiOutputs = Array.from(midiAccess.outputs.values());

      // MIDI OUT (para reproducir alumno)
      midiOutSelectCont.innerHTML='';
      if(midiOutputs.length){
        const sel = document.createElement('select');
        sel.innerHTML='<option value="">-- Elige tu teclado --</option>';
        midiOutputs.forEach((o,i)=> sel.innerHTML+=`<option value="${i}">${o.name}</option>`);
        sel.onchange = ()=>{
          midiOutDevice = sel.value? midiOutputs[+sel.value]: null;
          midiStatus.textContent = midiOutDevice? `MIDI OUT: ${midiOutDevice.name}`:'Usando virtual';
          useVirtual = !midiOutDevice;
        };
        midiOutSelectCont.appendChild(sel);
      } else midiOutSelectCont.textContent='(Sin salidas MIDI)';

      // MIDI IN (para enviar al alumno)  
      midiInSelectCont.innerHTML='';
      if(midiInputs.length){
        const selIn = document.createElement('select');
        selIn.innerHTML='<option value="">-- Elige entrada --</option>';
        midiInputs.forEach((i,k)=> selIn.innerHTML+=`<option value="${k}">${i.name}</option>`);
        selIn.onchange=()=>{
          if(midiInDevice) midiInDevice.onmidimessage=null;
          midiInDevice = selIn.value? midiInputs[+selIn.value]: null;
          if(midiInDevice){
            localMidiHandler = ({ data })=>{
              if(!canSendMidi) return;
              if(midiChannel.readyState==='open')
                midiChannel.send(JSON.stringify({ data:Array.from(data) }));
            };
            midiInDevice.onmidimessage = localMidiHandler;
            midiSendStatus.textContent=`Enviando desde: ${midiInDevice.name}`;
          } else {
            midiSendStatus.textContent=''; localMidiHandler=null;
          }
        };
        midiInSelectCont.appendChild(selIn);
      } else midiInSelectCont.textContent='(Sin entradas MIDI)';
    }
    async function setupSampler() {
      if(synth) return;
      await Tone.start();
      synth = new Tone.Sampler({
        urls:{ A0:'A0.mp3', C1:'C1.mp3','D#1':'Ds1.mp3','F#1':'Fs1.mp3',
               A1:'A1.mp3', C2:'C2.mp3','D#2':'Ds2.mp3','F#2':'Fs2.mp3',
               A2:'A2.mp3', C3:'C3.mp3','D#3':'Ds3.mp3','F#3':'Fs3.mp3',
               A3:'A3.mp3', C4:'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3',
               A4:'A4.mp3', C5:'C5.mp3','D#5':'Ds5.mp3','F#5':'Fs5.mp3',
               A5:'A5.mp3', C6:'C6.mp3','D#6':'Ds6.mp3','F#6':'Fs6.mp3',
               A7:'A7.mp3', C8:'C8.mp3' },
        baseUrl:'https://tonejs.github.io/audio/salamander/', release:0.4,
        onload:()=> midiStatus.textContent='Virtual listo'
      }).toDestination();
    }

    // â€” Handle raw MIDI and Simon messages â€”
    function handleDataChannel(msg) {
      // Simon message
      if(msg.type==='simon') {
        if(!msg.player) {
          piano.fillKey(msg.note);
          setTimeout(()=>piano.clearKey(msg.note),500);
        }
        return;
      }
      // Normal MIDI data
      if(Array.isArray(msg.data)) {
        const [st,note,vel]=msg.data, cmd=st&0xf0;
        const name = Tone.Frequency(note,'midi').toNote();
        if(cmd===0x90&&vel>0) piano.fillKey(name);
        else piano.clearKey(name);
        if(!useVirtual && midiOutDevice) midiOutDevice.send(new Uint8Array(msg.data));
        else {
          if(!synth) return;
          const freq=Tone.Frequency(note,'midi').toFrequency();
          if(cmd===0x90&&vel>0) synth.triggerAttack(freq,Tone.now(),vel/127);
          else synth.triggerRelease(freq,Tone.now());
        }
      }
    }

    // â€” Simon Game Logic â€”
    function pickRandomNote() {
      const all = piano.getKeys();
      return all[Math.floor(Math.random()*all.length)];
    }
    function playSequence(done) {
      keyboardEl.style.opacity='0.6';
      let i=0, iv=setInterval(()=>{
        const n=simonSeq[i];
        midiChannel.send(JSON.stringify({ type:'simon', note:n }));
        piano.fillKey(n); setTimeout(()=>piano.clearKey(n),500);
        i++; if(i>=simonSeq.length){ clearInterval(iv); setTimeout(done,300); }
      },800);
    }
    function nextStep() {
      simonSeq.push(pickRandomNote());
      playSequence(()=>{
        turn = (turn==='profesor'?'alumno':'profesor');
        canSendMidi = (turn===myRole);
        keyboardEl.style.opacity = canSendMidi?'1':'0.6';
        step=0;
        simonStatus.textContent = `Turno de ${turn.toUpperCase()}: repite ${simonSeq.length}`;
      });
    }
    function startSimon() {
      simonSeq=[]; turn='profesor'; step=0; canSendMidi=false;
      simonStatus.textContent='Generando nota para el PROFESORâ€¦';
      nextStep();
    }
    piano.on('press', note=>{
      if(!canSendMidi) return;
      midiChannel.send(JSON.stringify({ type:'simon', note, player:true }));
      if(note!==simonSeq[step]) {
        const winner='ALUMNO';
        simonStatus.innerHTML=`<span style="color:green">${winner} GANADOR</span>`;
        canSendMidi=false; keyboardEl.style.opacity='0.6';
      } else {
        step++;
        if(step>=simonSeq.length) nextStep();
      }
    });

    // â€” Simon button color change â€”
    simonBtn.addEventListener('mousedown', ()=> simonBtn.classList.add('active'));
    simonBtn.addEventListener('mouseup',   ()=> simonBtn.classList.remove('active'));
    simonBtn.addEventListener('mouseleave',()=> simonBtn.classList.remove('active'));
    simonBtn.addEventListener('click',     startSimon);
  </script>
</body>
</html>
