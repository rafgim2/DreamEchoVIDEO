<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DreamEcho - Oyente (V√≠deo + MIDI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tone.js para sonido virtual -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
  <style>
    html, body { height:100%; margin:0; font-family:sans-serif; background:#f5f5f5; }
    body { display:flex; justify-content:center; align-items:center; }
    .container {
      max-width:600px; width:90%; padding:2em;
      background:white; border-radius:1em;
      border:3px solid orange; box-shadow:0 0 20px rgba(0,0,0,0.1);
      text-align:center;
    }
    h1 { font-size:2.5em; margin-bottom:0.2em; }
    #remoteVideo {
      width:320px; height:240px;
      background:#000; margin-bottom:1em;
    }
    #status, #oyentes { font-size:1.2em; margin:0.5em 0; }
    #outputControls { margin:1em 0; }
    #midiOutputSelect { display:none; margin-left:0.5em; padding:0.3em; }
    #chatLog {
      height:200px; overflow-y:auto;
      border:1px solid #ccc; padding:0.5em;
      margin-bottom:0.5em; background:#fafafa;
      text-align:left;
    }
    #chatInput { width:70%; padding:0.5em; font-size:1em; }
    #sendChatBtn {
      padding:0.6em 1em; font-size:1em;
      cursor:pointer; margin-left:0.5em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>DreamEcho ‚Äì Oyente</h1>
    <video id="remoteVideo" autoplay playsinline></video>
    <p id="status">Conectando‚Ä¶</p>
    <p id="oyentes">Oyentes conectados: --</p>

    <!-- Salida MIDI / Virtual -->
    <div id="outputControls">
      <label>
        <input type="radio" name="output" value="virtual" checked>
        Sonido Virtual
      </label>
      <label style="margin-left:1em;">
        <input type="radio" name="output" value="midi">
        Piano Digital
      </label>
      <select id="midiOutputSelect">
        <option value="">Selecciona dispositivo MIDI</option>
      </select>
    </div>

    <div id="chatLog"></div>
    <input id="chatInput" placeholder="Escribe tu mensaje‚Ä¶">
    <button id="sendChatBtn">üó®Ô∏è Enviar</button>
  </div>

  <script>
    // --- DOM ---
    const statusEl        = document.getElementById('status');
    const oyentesEl       = document.getElementById('oyentes');
    const remoteVideo     = document.getElementById('remoteVideo');
    const chatLog         = document.getElementById('chatLog');
    const chatInput       = document.getElementById('chatInput');
    const sendBtn         = document.getElementById('sendChatBtn');
    const outputRadios    = document.querySelectorAll('input[name="output"]');
    const midiOutputSelect= document.getElementById('midiOutputSelect');

    // --- WebSocket para se√±alizaci√≥n, stats, chat y fallback MIDI ---
    const ws = new WebSocket('wss://dreamecho.onrender.com');
    // aseguramos que textos grandes no vengan como Blob
    ws.binaryType = 'arraybuffer';

    // --- WebRTC PeerConnection ---
    const pc = new RTCPeerConnection({
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { // TURN de prueba
          urls:  'turn:openrelay.metered.ca:80',
          username: 'openrelayproject',
          credential: 'openrelayproject'
        }
      ]
    });
    let midiChannel = null;

    // --- Synth virtual Tone.js ---
    const synth = new Tone.PolySynth(Tone.Synth).toDestination();

    // Estado de MIDI hardware
    let midiAccess = null;
    let midiOutput = null;

    ////////////////////////////////
    // 1) WebSocket ‚Üí Peer signaling
    ////////////////////////////////

    // Al llegar mensajes WebSocket
    ws.onmessage = async event => {
      let raw = event.data;
      let msg;

      // 1) si es arraybuffer (blob reconvertido), pasarlo a texto
      if (raw instanceof ArrayBuffer) {
        try {
          raw = new TextDecoder().decode(raw);
        } catch {
          return; // no es JSON, puede ignorarse
        }
      }
      // 2) si no es string, ignorar
      if (typeof raw !== 'string') return;

      // 3) parse JSON seguro
      try {
        msg = JSON.parse(raw);
      } catch {
        console.warn('Mensaje no JSON recibido por WS, se ignora.');
        return;
      }

      // --- Se√±alizaci√≥n WebRTC ---
      if (msg.type === 'signal') {
        const { data } = msg;
        if (data.sdp) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
          if (data.sdp.type === 'offer') {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type:'signal', data:{ sdp: pc.localDescription }}));
          }
        } else if (data.candidate) {
          try {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
          } catch {}
        }
        return;
      }

      // --- Estad√≠sticas ---
      if (msg.type === 'stats') {
        oyentesEl.innerText = `Oyentes conectados: ${msg.clients}`;
        return;
      }

      // --- Chat ---
      if (msg.type === 'chat') {
        const d = document.createElement('div');
        d.innerHTML = `<strong>${msg.user}:</strong> ${msg.text}`;
        chatLog.appendChild(d);
        chatLog.scrollTop = chatLog.scrollHeight;
        return;
      }

      // --- Fallback MIDI por WS ---
      if (msg.type === 'midi') {
        playMIDI(msg.data);
      }
    };

    ws.onopen    = () => statusEl.innerText = 'Conectado. Esperando v√≠deo y MIDI.';
    ws.onclose   = () => statusEl.innerText = 'Conexi√≥n WebSocket cerrada.';
    ws.onerror   = () => statusEl.innerText = 'Error en WebSocket.';

    // Enviar candidatos ICE al servidor
    pc.onicecandidate = ({ candidate }) => {
      if (candidate) {
        ws.send(JSON.stringify({ type:'signal', data:{ candidate }}));
      }
    };

    //////////////////////////////////
    // 2) Recepci√≥n de v√≠deo y MIDI
    //////////////////////////////////

    // V√≠deo remoto
    pc.ontrack = ev => {
      remoteVideo.srcObject = ev.streams[0];
      statusEl.innerText = 'V√≠deo recibido';
    };

    // Canal MIDI WebRTC
    pc.ondatachannel = ev => {
      if (ev.channel.label === 'midiChannel') {
        midiChannel = ev.channel;
        midiChannel.onopen = () => statusEl.innerText = 'Canal MIDI abierto';
        midiChannel.onmessage = e => {
          const msg = JSON.parse(e.data);
          playMIDI(msg.data);
        };
      }
    };

    //////////////////////////////////
    // 3) Chat cliente
    //////////////////////////////////
    sendBtn.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (!text) return;
      ws.send(JSON.stringify({ type:'chat', user:'Oyente', text }));
      chatInput.value = '';
    });
    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendBtn.click();
    });

    //////////////////////////////////
    // 4) MIDI Hardware / Virtual
    //////////////////////////////////
    navigator.requestMIDIAccess()
      .then(access => {
        midiAccess = access;
        // rellenar salidas
        midiAccess.outputs.forEach((port) => {
          const opt = document.createElement('option');
          opt.value = port.id;
          opt.text  = port.name;
          midiOutputSelect.appendChild(opt);
        });
      })
      .catch(() => console.warn('No se pudo acceder a Web MIDI'));

    // Mostrar u ocultar selector seg√∫n opci√≥n elegida
    outputRadios.forEach(r => r.addEventListener('change', () => {
      midiOutputSelect.style.display = (r.value==='midi' && r.checked) ? '' : 'none';
    }));
    midiOutputSelect.addEventListener('change', () => {
      midiOutput = midiAccess.outputs.get(midiOutputSelect.value) || null;
    });

    // Funci√≥n que reproduce un mensaje MIDI
    function playMIDI(data) {
      const [status, note, velocity] = data;
      const cmd = status & 0xf0;
      const useHW = document.querySelector('input[name="output"]:checked').value === 'midi';
      if (useHW && midiOutput) {
        midiOutput.send(data);
      } else {
        const freq = Tone.Frequency(note, 'midi');
        if (cmd === 0x90 && velocity > 0) {
          synth.triggerAttack(freq);
        } else {
          synth.triggerRelease(freq);
        }
      }
    }
  </script>
</body>
</html>
