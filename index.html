<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DreamEcho - Oyente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; text-align: center; background-color: #c1f7f2; margin: 0; min-height: 100vh; overflow-x: hidden; overflow-y: auto; }
    .marco { width: 90%; max-width: 600px; margin: 1em auto; padding: 1em; background: white; border: 5px solid blue; border-radius: 1em; box-sizing: border-box; }
    h1 { font-size: 2.5em; margin: 0.2em 0; }
    #recuentoOyentes, #status { font-size: 1.1em; color: #555; margin: 0.5em 0; }
    button { margin: 0.5em; font-size: 1em; padding: 0.8em 1.5em; cursor: pointer; }
    .video-container { display: flex; gap: 1em; justify-content: center; flex-wrap: wrap; margin: 1em 0; }
    .video-block { flex: 1 1 45%; display: flex; flex-direction: column; align-items: center; }
    .video-block video { width: 100%; max-height: 250px; background: black; border-radius: 0.5em; }
    .video-label { margin-top: 0.3em; font-weight: bold; color: #333; }
    #midiSelectContainer select { margin-top: 1em; padding: 0.5em; font-size: 1em; }
    #chatLog { width: 100%; height: 180px; margin: 1em 0 0.5em; padding: 0.5em; border: 1px solid #ccc; overflow-y: auto; text-align: left; background: #fafafa; border-radius: 0.5em; }
    #chatInput { width: 70%; padding: 0.5em; font-size: 1em; }
    #sendChatBtn { padding: 0.6em 1em; font-size: 1em; margin-left: 0.5em; cursor: pointer; }
    .chat-mensaje-propio { color: blue; }
    .ripple { position: fixed; border-radius: 50%; transform: scale(0); pointer-events: none; animation: rippleAnim 0.8s ease-out forwards; }
    @keyframes rippleAnim { to { transform: scale(15); opacity: 0; } }
  </style>
</head>
<body>
  <div class="marco">
    <h1>DreamEcho - Oyente</h1>
    <p><a href="https://www.youtube.com/@rafgim" target="_blank" rel="noopener">¬© By Rafael Gimeno</a></p>

    <div class="video-container">
      <div class="video-block">
        <video id="localVideo" autoplay muted playsinline></video>
        <p class="video-label">T√∫</p>
      </div>
      <div class="video-block">
        <video id="remoteVideo" autoplay playsinline></video>
        <p class="video-label">Artista</p>
      </div>
    </div>

    <p id="recuentoOyentes">Oyentes conectados: --</p>
    <p id="status">Esperando conexi√≥n‚Ä¶</p>

    <button id="talkBtn">üé§ Pulsar para hablar</button>
    <button onclick="modoMIDI()">üéπ Usar mi piano digital</button>
    <button onclick="modoVirtual()">üéß Escuchar con sonido virtual</button>

    <div id="midiSelectContainer"></div>

    <div id="chatControles">
      <div id="chatLog"></div>
      <input id="chatInput" placeholder="Escribe tu mensaje‚Ä¶" />
      <button id="sendChatBtn">üó®Ô∏è Enviar</button>
    </div>
  </div>

  <script>
    // ====== DOM Elements ======
    const statusEl = document.getElementById('status');
    const oyentesEl = document.getElementById('recuentoOyentes');
    const remoteVideo = document.getElementById('remoteVideo');
    const localVideo  = document.getElementById('localVideo');
    const talkBtn     = document.getElementById('talkBtn');
    const chatLog     = document.getElementById('chatLog');
    const chatInput   = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const midiSelectContainer = document.getElementById('midiSelectContainer');

    // ====== State ======
    let output = null;          // MIDI output
    let synth  = null;          // Tone.js sampler
    let pedal  = false;
    const notasActivas   = new Set();
    const notasSostenidas= new Set();

    const ws = new WebSocket('wss://dreamecho.onrender.com');
    const pc = new RTCPeerConnection({ iceServers:[{ urls:'stun:stun.l.google.com:19302' }]});
    let midiChannel = null;

    // Walkie‚Äëtalkie flags
    let pressingTalk   = false;
    let remoteSpeaking = false;
    let audioTrack     = null;
    let localStream    = null;

    // ====== Utility ======
    function updateMicState() {
      if (!audioTrack) return;
      const active = pressingTalk && !remoteSpeaking;
      audioTrack.enabled = active;
    }

    function pressTalk() {
      pressingTalk = true;
      ws.send(JSON.stringify({ type:'talk', speaking:true }));
      updateMicState();
    }
    function releaseTalk() {
      pressingTalk = false;
      ws.send(JSON.stringify({ type:'talk', speaking:false }));
      updateMicState();
    }

    ['mousedown','touchstart'].forEach(e=>talkBtn.addEventListener(e,pressTalk));
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(e=>talkBtn.addEventListener(e,releaseTalk));

    // ====== Local Media ======
    async function setupLocalStream() {
      if (localStream) return; // already done
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
      localVideo.srcObject = localStream;
      audioTrack = localStream.getAudioTracks()[0];
      audioTrack.enabled = false; // start muted
    }

    // ====== WebRTC callbacks ======
    pc.onicecandidate = ({candidate})=>{ if(candidate) ws.send(JSON.stringify({type:'signal',candidate})); };
    pc.ontrack = ev => remoteVideo.srcObject = ev.streams[0];
    pc.ondatachannel = ev => {
      if (ev.channel.label==='midi') {
        midiChannel = ev.channel;
        midiChannel.onmessage = ({data})=>handleMidiMessage(JSON.parse(data));
      }
    };

    // ====== WebSocket callbacks ======
    ws.onopen = ()=> statusEl.textContent='Conectado, esperando oferta...';
    ws.onmessage = async ({data}) => {
      const msg = JSON.parse(typeof data==='string'?data: await data.text());
      switch(msg.type){
        case 'stats': oyentesEl.textContent = `Oyentes conectados: ${msg.clients}`; break;
        case 'chat' : appendChat(msg.user,msg.text); break;
        case 'talk' : remoteSpeaking = msg.speaking; updateMicState(); break;
        case 'signal':
          if (msg.offer){
            await setupLocalStream();
            await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({type:'signal', answer: pc.localDescription}));
          } else if (msg.answer){
            await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
          } else if (msg.candidate){
            await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
          }
          break;
      }
    };
    ws.onerror = ()=> statusEl.textContent='Error en la conexi√≥n.';
    ws.onclose = ()=> statusEl.textContent='Conexi√≥n cerrada.';

    // ====== Chat ======
    const username = prompt('¬øC√≥mo quieres que te vean en el chat?','Oyente')||'Oyente';
    function appendChat(u,t){
      const e=document.createElement('div');
      e.innerHTML=`<small>[${new Date().toLocaleTimeString()}]</small> <strong>${u}:</strong> ${t}`;
      if(u===username) e.classList.add('chat-mensaje-propio');
      chatLog.appendChild(e); chatLog.scrollTop=chatLog.scrollHeight;
    }
    function sendChat(){
      const t=chatInput.value.trim();
      if(t&&ws.readyState===WebSocket.OPEN){ ws.send(JSON.stringify({type:'chat', user:username, text:t})); chatInput.value=''; }
    }
    sendChatBtn.addEventListener('click',sendChat);
    chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter') sendChat(); });

    // ====== MIDI Functions ======
    function modoMIDI(){
      statusEl.textContent='Buscando dispositivos MIDI‚Ä¶';
      navigator.requestMIDIAccess().then(ma=>{
        const outputs=[...ma.outputs.values()];
        if(!outputs.length){ statusEl.textContent='No hay dispositivos MIDI.'; return; }
        midiSelectContainer.innerHTML='';
        const sel=document.createElement('select');
        sel.innerHTML='<option value="">-- Elige salida MIDI --</option>';
        outputs.forEach(o=> sel.innerHTML+=`<option value='${o.id}'>${o.name}</option>`);
        sel.onchange=()=>{ output = ma.outputs.get(sel.value); statusEl.textContent =`Salida MIDI: ${output.name}`; };
        sel.value=outputs[0].id;
        sel.dispatchEvent(new Event('change'));
        midiSelectContainer.appendChild(sel);
      }).catch(()=> statusEl.textContent='No se pudo acceder a MIDI.');
    }

    async function modoVirtual(){
      statusEl.textContent='Cargando piano virtual‚Ä¶';
      pedal=false; notasActivas.clear(); notasSostenidas.clear();
      await Tone.start();
      synth = new Tone.Sampler({
        urls:{"C4":"C4.mp3","E4":"E4.mp3","G4":"G4.mp3"},
        baseUrl:'https://tonejs.github.io/audio/salamander/',
        release:0.4,
        onload:()=> statusEl.textContent='Modo virtual listo.'
      }).toDestination();
    }

    function handleMidiMessage(msg){
      const [st,note,vel] = msg.data;
      const cmd = st & 0xf0;
      if(cmd===0x90 && vel>0){
        const velNorm = vel/127; synth?.triggerAttack(Tone.Frequency(note,'midi'), Tone.now(), velNorm*velNorm);
      } else if(cmd===0x80 || (cmd===0x90 && vel===0)){
        synth?.triggerRelease(Tone.Frequency(note,'midi'), Tone.now());
      }
      if(output) output.send(new Uint8Array(msg.data));
    }
  </script>
</body>
</html>
