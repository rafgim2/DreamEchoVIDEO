<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DreamEcho - Oyente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      text-align: center;
      background-color: #c1f7f2;
      margin: 0;
      min-height: 100vh;
    }

    .marco {
      width: 90%;
      max-width: 700px;
      margin: 1em auto;
      padding: 1em;
      background: white;
      border: 5px solid blue;
      border-radius: 1em;
      box-sizing: border-box;
    }

    .video-container {
      display: flex;
      gap: 1em;
      justify-content: center;
      flex-wrap: wrap;
      margin: 1em 0;
    }

    .video-block {
      flex: 1 1 45%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .video-block video {
      width: 100%;
      max-height: 250px;
      background: black;
      border-radius: 0.5em;
    }

    .video-label {
      margin-top: 0.3em;
      font-weight: bold;
      color: #333;
    }

    #talkBtn {
      padding: 0.8em 2em;
      font-size: 1.1em;
      margin: 1em 0;
      border: none;
      border-radius: 0.7em;
      background: #2196f3;
      color: #fff;
      cursor: pointer;
    }

    #talkBtn:active {
      transform: scale(0.96);
    }

    #chatLog {
      width: 100%;
      height: 180px;
      margin: 1em 0 0.5em;
      padding: 0.5em;
      border: 1px solid #ccc;
      overflow-y: auto;
      text-align: left;
      background: #fafafa;
      border-radius: 0.5em;
    }

    #chatInput {
      width: 70%;
      padding: 0.5em;
      font-size: 1em;
    }

    #sendChatBtn {
      padding: 0.6em 1em;
      font-size: 1em;
      margin-left: 0.5em;
      cursor: pointer;
    }

    .chat-mensaje-propio {
      color: blue;
    }

    .video-label, #recuentoOyentes, #status {
      font-size: 1.1em;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="marco">
    <h1>DreamEcho - Oyente</h1>
    <p><a href="https://www.youtube.com/@rafgim" target="_blank">¬© By Rafael Gimeno</a></p>

    <div class="video-container">
      <div class="video-block">
        <video id="localVideo" autoplay muted playsinline></video>
        <p class="video-label">T√∫</p>
      </div>
      <div class="video-block">
        <video id="remoteVideo" autoplay playsinline></video>
        <p class="video-label">Artista</p>
      </div>
    </div>

    <button id="talkBtn">üé§ Mant√©n pulsado para hablar</button>

    <p id="recuentoOyentes">Oyentes conectados: --</p>
    <p id="status">Esperando conexi√≥n‚Ä¶</p>

    <div id="chatControles">
      <div id="chatLog"></div>
      <input id="chatInput" placeholder="Escribe tu mensaje‚Ä¶" />
      <button id="sendChatBtn">üó®Ô∏è Enviar</button>
    </div>
  </div>

  <script>
    const ws = new WebSocket('wss://dreamecho.onrender.com');
    const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

    const username = prompt('¬øC√≥mo quieres que te vean en el chat?', 'Oyente') || 'Oyente';
    const remoteVideo = document.getElementById('remoteVideo');
    const localVideo = document.getElementById('localVideo');
    const statusEl = document.getElementById('status');
    const oyentesEl = document.getElementById('recuentoOyentes');
    const chatLog = document.getElementById('chatLog');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const talkBtn = document.getElementById('talkBtn');

    let midiChannel = null;
    let audioTrack = null;
    let localStream = null;
    let pressingTalk = false;
    let remoteSpeaking = false;

    async function initLocalVideo() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        audioTrack = localStream.getAudioTracks()[0];
        audioTrack.enabled = false; // desactivado por defecto
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'No se pudo acceder a la c√°mara/micro.';
      }
    }

    function updateMicState() {
      if (!audioTrack) return;
      audioTrack.enabled = pressingTalk && !remoteSpeaking;
    }

    function pressTalk() {
      pressingTalk = true;
      ws.send(JSON.stringify({ type: 'talk', speaking: true }));
      updateMicState();
    }

    function releaseTalk() {
      pressingTalk = false;
      ws.send(JSON.stringify({ type: 'talk', speaking: false }));
      updateMicState();
    }

    ['mousedown', 'touchstart'].forEach(e => talkBtn.addEventListener(e, pressTalk));
    ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(e => talkBtn.addEventListener(e, releaseTalk));

    pc.onicecandidate = ({ candidate }) => {
      if (candidate) ws.send(JSON.stringify({ type: 'signal', candidate }));
    };

    pc.ontrack = ev => {
      remoteVideo.srcObject = ev.streams[0];
    };

    pc.ondatachannel = ev => {
      if (ev.channel.label === 'midi') {
        midiChannel = ev.channel;
        midiChannel.onmessage = ({ data }) => {
          // manejo de MIDI si quieres
        };
      }
    };

    ws.onopen = () => {
      statusEl.textContent = 'Conectado, esperando oferta...';
      initLocalVideo();
    };

    ws.onmessage = async ({ data }) => {
      const msg = JSON.parse(data);
      switch (msg.type) {
        case 'stats':
          oyentesEl.textContent = `Oyentes conectados: ${msg.clients}`;
          break;
        case 'chat':
          appendChat(msg.user, msg.text);
          break;
        case 'talk':
          remoteSpeaking = msg.speaking;
          updateMicState();
          break;
        case 'signal':
          if (msg.offer) {
            await initLocalVideo();
            await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: 'signal', answer: pc.localDescription }));
          } else if (msg.answer) {
            await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
          } else if (msg.candidate) {
            await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
          }
          break;
      }
    };

    function appendChat(user, text) {
      const msgEl = document.createElement('div');
      msgEl.innerHTML = `<small>[${new Date().toLocaleTimeString()}]</small> <strong>${user}:</strong> ${text}`;
      if (user === username) msgEl.classList.add('chat-mensaje-propio');
      chatLog.appendChild(msgEl);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function sendChat() {
      const t = chatInput.value.trim();
      if (t && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'chat', user: username, text: t }));
        chatInput.value = '';
      }
    }

    sendChatBtn.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendChat(); });
  </script>
</body>
</html>
