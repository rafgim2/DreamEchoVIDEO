<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DreamEcho - Oyente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; text-align: center; background-color: #c1f7f2; margin:0; min-height:100vh; }
    .marco { width:90%; max-width:700px; margin:1em auto; padding:1em; background:white; border:5px solid blue; border-radius:1em; box-shadow:0 0 15px rgba(0,0,0,0.1); }
    h1 { font-size:2.5em; margin:0.2em 0; }
    .video-box { display:flex; gap:1em; justify-content:center; margin-bottom:1em; }
    .video-wrap { flex:1; display:flex; flex-direction:column; align-items:center; }
    video { width:100%; max-height:240px; background:black; border-radius:0.5em; }
    .video-wrap span { font-size:0.9em; color:#555; margin-top:0.4em; }
    #talkBtn {
      background: blue; color: white; border:none; border-radius:0.5em;
      font-size:1.1em; padding:0.6em 1.4em; margin:0.5em; cursor:pointer;
      transition: background 0.2s;
    }
    #talkBtn:active { background: #003f7f; }
    #talkStatus { margin:0.5em 0; color:#333; }
    button { margin:0.5em; font-size:1em; padding:0.6em 1.2em; cursor:pointer; }
    #midiSelectContainer select { margin-top:1em; padding:0.5em; font-size:1em; }
    #chatLog { width:100%; height:150px; margin:1em 0 0.5em; padding:0.5em; border:1px solid #ccc; overflow-y:auto; text-align:left; background:#fafafa; border-radius:0.5em; }
    #chatInput { width:70%; padding:0.5em; font-size:1em; }
    #sendChatBtn { padding:0.6em 1em; font-size:1em; margin-left:0.5em; cursor:pointer; }
    .chat-propio { color:blue; }
  </style>
</head>
<body>
  <div class="marco">
    <h1>DreamEcho - Oyente</h1>
    <p><a href="https://www.youtube.com/@rafgim" target="_blank" rel="noopener">¬© By Rafael Gimeno</a></p>

    <div class="video-box">
      <div class="video-wrap">
        <video id="localVideo" autoplay muted playsinline></video>
        <span>T√∫</span>
      </div>
      <div class="video-wrap">
        <video id="remoteVideo" autoplay playsinline></video>
        <span>Artista</span>
      </div>
    </div>

    <div id="talkStatus">Walkie-talkie: Mant√©n pulsado para hablar</div>
    <button id="talkBtn">üîä Hablar</button>

    <p id="recuentoOyentes">Oyentes conectados: --</p>
    <p id="status">Esperando conexi√≥n‚Ä¶</p>

    <button onclick="modoMIDI()">üéπ Usar mi piano digital</button>
    <button onclick="modoVirtual()">üéß Escuchar con sonido virtual</button>

    <div id="midiSelectContainer"></div>

    <div id="chatControles">
      <div id="chatLog"></div>
      <input id="chatInput" placeholder="Escribe tu mensaje‚Ä¶" />
      <button id="sendChatBtn">üó®Ô∏è Enviar</button>
    </div>
  </div>

  <script>
    // 1) Captura c√°mara/micr√≥fono local
    let localStream = null;
    (async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
      } catch (err) {
        alert('Error c√°mara/micro: ' + err.name);
        console.error(err);
      }
    })();

    // 2) Variables globales
    let ws=null, pc=null, midiChannel=null, activeMIDIInput=null;
    let startTime=null, prevClients=0;
    let remoteStream=null;
    const username = prompt('¬øC√≥mo quieres que te vean en el chat?', 'Oyente')||'Oyente';

    // Walkie
    let localAudioTrack=null, isTalking=false, otherIsTalking=false;

    // 3) Inicia WebSocket
    function initWS(){
      ws=new WebSocket('wss://dreamecho.onrender.com');
      ws.onopen = ()=>{ document.getElementById('status').textContent='Conectado, esperando oferta...'; };
      ws.onmessage = async ({data})=>{
        const msg = JSON.parse(typeof data==='string'?data:await data.text());
        if(msg.type==='stats'){
          document.getElementById('recuentoOyentes').textContent=`Oyentes conectados: ${msg.clients}`;
        }
        if(msg.type==='chat') appendChat(msg.user,msg.text);
        if(msg.type==='signal') await handleSignal(msg);
      };
      ws.onerror = ()=>{ document.getElementById('status').textContent='Error en WS.'; };
      ws.onclose = ()=>{ document.getElementById('status').textContent='WS cerrado.'; };
    }
    function sendSignal(d){ if(ws&&ws.readyState===1) ws.send(JSON.stringify({type:'signal',...d})); }

    // 4) Arranca/renegocia WebRTC
    async function startWebRTC(){
      if(pc) try{ pc.close(); }catch{}
      pc=new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });

      // ICE
      pc.onicecandidate = e=>{ if(e.candidate) sendSignal({candidate:e.candidate}); };

      // Prepara remoteStream
      remoteStream=new MediaStream();
      document.getElementById('remoteVideo').srcObject=remoteStream;
      pc.ontrack = ev=>{
        if(!remoteStream.getTracks().find(t=>t.id===ev.track.id)){
          remoteStream.addTrack(ev.track);
        }
      };

      // DataChannel (si artista crea primero)
      pc.ondatachannel = ev=>{
        if(ev.channel.label==='midi'){
          midiChannel=ev.channel;
          midiChannel.onmessage = handleDCMessage;
        }
      };

      // A√±ade tracks locales
      if(localStream){
        localAudioTrack=localStream.getAudioTracks()[0];
        if(localAudioTrack) localAudioTrack.enabled=false;
        localStream.getTracks().forEach(track=>{
          if(!pc.getSenders().find(s=>s.track&&s.track.id===track.id)){
            pc.addTrack(track, localStream);
          }
        });
      }

      // Crea canal midi si no existe
      if(!midiChannel||midiChannel.readyState==='closed'){
        midiChannel=pc.createDataChannel('midi');
        midiChannel.onmessage=handleDCMessage;
      }

      // Oferta/negociaci√≥n
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
      sendSignal({offer:pc.localDescription});
    }

    // 5) Manejo se√±alizaci√≥n
    async function handleSignal(msg){
      if(msg.offer){
        pc.addTransceiver('video',{direction:'recvonly'});
        await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
        const answer=await pc.createAnswer();
        await pc.setLocalDescription(answer);
        sendSignal({answer:pc.localDescription});
      }
      if(msg.answer) await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
      if(msg.candidate) await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
    }

    // 6) Chat
    function appendChat(user,text){
      const log=document.getElementById('chatLog');
      const d=document.createElement('div');
      const t=new Date().toLocaleTimeString();
      d.innerHTML=`<small>[${t}]</small> <strong>${user}:</strong> ${text}`;
      if(user===username) d.classList.add('chat-propio');
      log.appendChild(d); log.scrollTop=log.scrollHeight;
    }
    document.getElementById('sendChatBtn').addEventListener('click',()=>{
      const inp=document.getElementById('chatInput');
      const txt=inp.value.trim();
      if(txt&&ws.readyState===1){
        ws.send(JSON.stringify({type:'chat',user:username,text:txt}));
        inp.value='';
      }
    });
    document.getElementById('chatInput').addEventListener('keydown',e=>{
      if(e.key==='Enter') document.getElementById('sendChatBtn').click();
    });

    // 7) MIDI local
    function modoMIDI(){
      document.getElementById('status').textContent='Buscando MIDI‚Ä¶';
      navigator.requestMIDIAccess().then(ma=>{
        const outs=Array.from(ma.outputs.values());
        if(!outs.length){ document.getElementById('status').textContent='Sin MIDI.'; return; }
        const c=document.getElementById('midiSelectContainer');
        c.innerHTML='';
        const sel=document.createElement('select');
        sel.innerHTML='<option value="">-- Salida MIDI --</option>';
        outs.forEach(o=> sel.innerHTML+=`<option value="${o.id}">${o.name}</option>`);
        sel.onchange=()=>{ output=ma.outputs.get(sel.value); document.getElementById('status').textContent=`MIDI: ${output.name}`; };
        sel.value=outs[0].id; sel.dispatchEvent(new Event('change'));
        c.appendChild(sel);
      }).catch(()=>{ document.getElementById('status').textContent='No acceso MIDI.'; });
    }
    let output=null, synth=null, pedal=false, notasAct=new Set(), notasSol=new Set();
    async function modoVirtual(){
      document.getElementById('status').textContent='Cargando piano‚Ä¶';
      pedal=false; notasAct.clear(); notasSol.clear();
      await Tone.start();
      synth=new Tone.Sampler({ urls:{A0:'A0.mp3',C1:'C1.mp3', /*‚Ä¶*/}, baseUrl:'https://tonejs.github.io/audio/salamander/', release:0.4 })
        .toDestination();
      synth.onload = ()=> document.getElementById('status').textContent='Modo virtual listo.';
    }

    function handleMidiMessage(msg){
      const [st,n,vel]=msg.data, cmd=st&0xf0;
      // efecto ripple
      if(cmd===0x90&&vel>0){
        const dot=document.createElement('div'); dot.classList.add('ripple');
        document.body.appendChild(dot); setTimeout(()=>dot.remove(),800);
      }
      if(output) output.send(new Uint8Array(msg.data));
      if(synth){
        const freq=Tone.Frequency(n,'midi').toFrequency();
        if(cmd===0x90&&vel>0){
          const v=(vel/127)**2;
          synth.triggerAttack(freq, Tone.now(), v); notasAct.add(freq); notasSol.delete(freq);
        } else if(cmd===0x80||(cmd===0x90&&vel===0)){
          if(pedal){ notasAct.delete(freq); notasSol.add(freq);
          } else { synth.triggerRelease(freq); notasAct.delete(freq); notasSol.delete(freq); }
        } else if(st===176&&n===64){
          if(vel>=64) pedal=true;
          else { pedal=false; notasSol.forEach(f=>{ if(!notasAct.has(f)){ synth.triggerRelease(f); notasSol.delete(f); }}); }
        }
      }
    }

    // 8) Walkie-talkie
    function setTalk(){
      const s=document.getElementById('talkStatus');
      if(isTalking) s.innerHTML='<b>Est√°s hablando</b>';
      else if(otherIsTalking) s.innerHTML='<b>El artista habla</b>';
      else s.textContent='Walkie-talkie: Mant√©n pulsado para hablar';
    }
    function sendWalkie(t){
      if(midiChannel&&midiChannel.readyState==='open'){
        midiChannel.send(JSON.stringify({type:'walkie',talking:t}));
      }
    }
    function handleDCMessage(ev){
      try{
        const m=JSON.parse(ev.data);
        if(m.type==='walkie'){
          otherIsTalking=m.talking;
          if(localAudioTrack) localAudioTrack.enabled = !otherIsTalking && isTalking;
          setTalk();
        }
        if(m.type==='midi') handleMidiMessage(m);
      }catch{}
    }

    const btn=document.getElementById('talkBtn');
    btn.addEventListener('mousedown',()=>{
      isTalking=true;
      if(localAudioTrack) localAudioTrack.enabled=true;
      sendWalkie(true); setTalk();
    });
    btn.addEventListener('mouseup',()=>{
      isTalking=false;
      if(localAudioTrack) localAudioTrack.enabled=false;
      sendWalkie(false); setTalk();
    });
    ['mouseleave','touchend','touchcancel'].forEach(e=>
      btn.addEventListener(e,()=>{
        isTalking=false;
        if(localAudioTrack) localAudioTrack.enabled=false;
        sendWalkie(false); setTalk();
      })
    );

    // 9) Inicializa todo
    initWS();
    startWebRTC();
  </script>
</body>
</html>
